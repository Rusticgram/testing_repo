name: iOS TestFlight Deployment

on:
  push:
    branches: [ main ]  # release branch

jobs:
  build-and-upload:
    runs-on: macos-latest

    env:
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      IOS_DEV_PROFILE: ${{ secrets.IOS_DEV_PROFILE }}  # base64 of .mobileprovision
      IOS_DIST_CERT: ${{ secrets.IOS_DIST_CERT }}  # base64 of .p12
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      FLUTTER_VERSION: '3.35.4'  # set to your local Flutter version
      COCOAPODS_VERSION: '1.16.2'  # set to your local CocoaPods version
      BUNDLER_VERSION: '2.7.2'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}  # match local version
          cache: true  # reuse downloaded SDK across workflow runs
          cache-key: flutter-sdk-${{ runner.os }}-${{ env.FLUTTER_VERSION }}  # only re-install when version changes

      # Cache Flutter pub packages to avoid re-downloading on each run
      - name: Cache pub cache
        uses: actions/cache@v4
        with:
          path: /Users/runner/.pub-cache
          key: pub-${{ runner.os }}-${{ env.FLUTTER_VERSION }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-${{ env.FLUTTER_VERSION }}-

      - name: Flutter pub get
        run: flutter pub get

      # Cache Ruby gems for fastlane/bundler
      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ env.BUNDLER_VERSION }}-${{ hashFiles('ios/Gemfile', 'ios/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ env.BUNDLER_VERSION }}-
            ${{ runner.os }}-gems-

      - name: Bundle install
        working-directory: ios
        run: |
          gem install bundler -v $BUNDLER_VERSION
          bundle config set --local path ../vendor/bundle
          bundle _${BUNDLER_VERSION}_ install --jobs 4 --retry 3

      # Cache CocoaPods gem + pods artifacts; reinstall only when version changes
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/.gem
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-cocoapods-${{ env.COCOAPODS_VERSION }}
          restore-keys: ${{ runner.os }}-cocoapods-

      # 1) Install CocoaPods (version pinned)
      - name: Install CocoaPods
        run: sudo gem install cocoapods -v $COCOAPODS_VERSION -NV

      # 2) Run pod install in ios/
      - name: Pod install
        working-directory: ios
        run: pod install

      # 3) Install fastlane
      - name: Install fastlane
        run: sudo gem install fastlane -NV

      # 4) Build + upload to TestFlight (fastlane beta)
      - name: Build & Upload to TestFlight
        working-directory: ios
        run: bundle exec fastlane beta
