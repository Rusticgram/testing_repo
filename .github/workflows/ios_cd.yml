name: iOS TestFlight Deployment

on:
  push:
    branches: [ main ]  # release branch

jobs:
  build-and-upload:
    runs-on: macos-latest

    env:
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      - name: Flutter pub get
        run: flutter pub get

      - name: Flutter tests
        run: flutter test

      # 1) Install CocoaPods
      - name: Install CocoaPods
        run: sudo gem install cocoapods -NV

      # 2) Run pod install in ios/
      - name: Pod install
        working-directory: ios
        run: pod install

      # 3) Install fastlane
      - name: Install fastlane
        run: sudo gem install fastlane -NV

      # 4) Build + upload to TestFlight (fastlane beta)
      - name: Build & Upload to TestFlight
        working-directory: ios
        run: fastlane beta
