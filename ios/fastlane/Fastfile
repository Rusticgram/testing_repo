# ios/fastlane/Fastfile
default_platform(:ios)
require "base64"
require "fileutils"

platform :ios do
  
  desc "Setup code signing"
  lane :setup_signing do
    #
    # 1) Create and setup keychain FIRST
    #
    keychain_name = "app-signing"
    keychain_password = "temp_keychain_password"
    
    # Delete keychain if it exists
    delete_keychain(
      name: keychain_name
    ) rescue nil
    
    # Create fresh keychain
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: false,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false,
      add_to_search_list: true
    )

    # Set as default keychain
    sh("security default-keychain -s ~/Library/Keychains/#{keychain_name}-db")
    sh("security unlock-keychain -p #{keychain_password} ~/Library/Keychains/#{keychain_name}-db")
    sh("security set-keychain-settings -lut 3600 ~/Library/Keychains/#{keychain_name}-db")

    #
    # 2) Import distribution certificate
    #
    cert_base64   = ENV["IOS_DIST_CERT"]
    cert_password = ENV["IOS_DIST_CERT_PASSWORD"]
    UI.user_error!("IOS_DIST_CERT is missing") if cert_base64.to_s.empty?
    UI.user_error!("IOS_DIST_CERT_PASSWORD is missing") if cert_password.to_s.empty?
    
    cert_path = File.expand_path("~/dist_cert.p12")
    File.open(cert_path, "wb") do |f|
      f.write(Base64.decode64(cert_base64))
    end

    # Import certificate using security command directly for better error handling
    sh("security import #{cert_path} -k ~/Library/Keychains/#{keychain_name}-db -P #{cert_password} -T /usr/bin/codesign -T /usr/bin/security")
    
    # Allow codesign to access the keychain
    sh("security set-key-partition-list -S apple-tool:,apple: -k #{keychain_password} ~/Library/Keychains/#{keychain_name}-db")

    #
    # 3) Install provisioning profile
    #
    profile_base64 = ENV["IOS_DEV_PROFILE"]
    UI.user_error!("IOS_DEV_PROFILE is missing") if profile_base64.to_s.empty?
    
    profiles_dir = File.expand_path("~/Library/MobileDevice/Provisioning Profiles")
    FileUtils.mkdir_p(profiles_dir)
    
    # Decode to get profile UUID
    profile_content = Base64.decode64(profile_base64)
    
    # Extract UUID from profile using regex
    uuid = profile_content.match(/<key>UUID<\/key>\s*<string>(.*?)<\/string>/m)[1]
    UI.message("Installing provisioning profile with UUID: #{uuid}")
    
    profile_path = File.join(profiles_dir, "#{uuid}.mobileprovision")
    File.open(profile_path, "wb") do |f|
      f.write(profile_content)
    end

    #
    # 4) Setup App Store Connect API key
    #
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )
  end

  desc "Full beta lane - build and upload"
  lane :beta do
    setup_signing
    
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # Get the profile UUID for export options
    profile_base64 = ENV["IOS_DEV_PROFILE"]
    profile_content = Base64.decode64(profile_base64)
    uuid = profile_content.match(/<key>UUID<\/key>\s*<string>(.*?)<\/string>/m)[1]

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "manual",
        teamID: ENV["APPLE_TEAM_ID"],
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => uuid
        }
      },
      xcargs: "-allowProvisioningUpdates COMPILER_INDEX_STORE_ENABLE=NO"
    )

    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end
end