# ios/fastlane/Fastfile

default_platform(:ios)

platform :ios do

  desc "Build IPA and upload to TestFlight (Automatic Signing)"
  lane :beta do

    # App Store Connect API key setup (required for automatic profile download)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    # Increment build number using agvtool
    increment_build_number(xcodeproj: "Runner.xcodeproj")

    # Build with FULLY AUTOMATIC signing - Xcode fetches perfect profile with ALL entitlements (Push Notifications, etc.)
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "Runner.ipa",
      buildlog_path: "./build/logs",
      xcargs: {
        "DEVELOPMENT_TEAM" => ENV["APPLE_TEAM_ID"],
        "COMPILER_INDEX_STORE_ENABLE" => "NO",
        # CRITICAL: Allows Xcode to automatically download/update provisioning profiles from Apple
        "ALLOW_PROVISIONING_UPDATES" => "YES",
        # Ensures automatic code signing (no manual cert/profile needed)
        "CODE_SIGN_STYLE" => "Automatic"
      },
      export_options: {
        method: "app-store"
        # Automatic signing handles everything else
      },
      verbose: true
    )

    # Upload to TestFlight (skip processing wait for CI)
    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      ipa: "./build/Runner.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end
end