# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# default_platform(:ios)

# platform :ios do
#   desc "Push a new beta build to TestFlight"
#   lane :beta do
#     increment_build_number(xcodeproj: "Runner.xcodeproj")
#     build_app(workspace: "Runner.xcworkspace", scheme: "Runner")
#     upload_to_testflight
#   end
# end

default_platform(:ios)

def app_store_key_content
  raw = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
  UI.user_error!("APP_STORE_CONNECT_API_KEY_CONTENT is missing") unless raw

  # If the secret was stored as base64 (common for CI), decode it; otherwise use as-is.
  return raw if raw.include?("BEGIN PRIVATE KEY")

  require "base64"
  Base64.strict_decode64(raw)
rescue ArgumentError
  UI.user_error!("APP_STORE_CONNECT_API_KEY_CONTENT must be PEM text or base64-encoded PEM")
end

platform :ios do
  desc "Push a new beta build to TestFlight (for CI and local)"
  lane :beta do
    # Authenticate using App Store Connect API key (no UI, CI-safe)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: app_store_key_content,
      is_key_content_base64: false,
      in_house: false
    )

    # Bump build number (same as your current file)
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # Build the app using the workspace + Runner scheme
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store"
    )

    # Upload to TestFlight
    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      skip_waiting_for_build_processing: true
    )
  end
end
