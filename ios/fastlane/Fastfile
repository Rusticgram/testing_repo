# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# default_platform(:ios)

# platform :ios do
#   desc "Push a new beta build to TestFlight"
#   lane :beta do
#     increment_build_number(xcodeproj: "Runner.xcodeproj")
#     build_app(workspace: "Runner.xcworkspace", scheme: "Runner")
#     upload_to_testflight
#   end
# end

# fastlane/Fastfile

default_platform(:ios)

require "base64"
require "fileutils"

platform :ios do
  desc "Push a new beta build to TestFlight (for CI and local)"
  lane :beta do
    #
    # 1) Decode & install provisioning profile (stored as base64 in IOS_DEV_PROFILE)
    #
    profile_base64 = ENV["IOS_DEV_PROFILE"]
    UI.user_error!("IOS_DEV_PROFILE is missing") if profile_base64.to_s.empty?

    profiles_dir = File.expand_path("~/Library/MobileDevice/Provisioning Profiles")
    FileUtils.mkdir_p(profiles_dir)

    profile_path = File.join(profiles_dir, "rusticgram_dist.mobileprovision")
    File.open(profile_path, "wb") do |f|
      f.write(Base64.decode64(profile_base64))
    end

    #
    # 2) Decode & import distribution certificate (.p12) from IOS_DIST_CERT
    #
    cert_base64   = ENV["IOS_DIST_CERT"]
    cert_password = ENV["IOS_DIST_CERT_PASSWORD"]

    UI.user_error!("IOS_DIST_CERT is missing") if cert_base64.to_s.empty?
    UI.user_error!("IOS_DIST_CERT_PASSWORD is missing") if cert_password.to_s.empty?

    cert_path = File.expand_path("dist_cert.p12")
    File.open(cert_path, "wb") do |f|
      f.write(Base64.decode64(cert_base64))
    end

    keychain_name = "app-signing.keychain-db"
    keychain_password = ENV["IOS_DIST_CERT_PASSWORD"] || "temp_keychain_password"

    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    import_certificate(
      certificate_path: cert_path,
      certificate_password: cert_password,
      keychain_name: keychain_name,
      keychain_password: keychain_password
    )

    #
    # 3) Authenticate using App Store Connect API key (CI-friendly, no UI)
    #
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"], # base64-encoded .p8
      is_key_content_base64: true,
      in_house: false
    )

    #
    # 4) Bump build number
    #
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    #
    # 5) Build the app
    #
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store"
      # team_id: ENV["APPLE_TEAM_ID"] # <- optional, only if you need it
    )

    #
    # 6) Upload to TestFlight
    #
    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      skip_waiting_for_build_processing: true
    )
  end
end
