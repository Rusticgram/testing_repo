# ios/fastlane/Fastfile
default_platform(:ios)
require "base64"
require "fileutils"

platform :ios do
  
  desc "Setup code signing"
  lane :setup_signing do
    #
    # 1) Decode & install provisioning profile
    #
    profile_base64 = ENV["IOS_DEV_PROFILE"]
    UI.user_error!("IOS_DEV_PROFILE is missing") if profile_base64.to_s.empty?
    
    profiles_dir = File.expand_path("~/Library/MobileDevice/Provisioning Profiles")
    FileUtils.mkdir_p(profiles_dir)
    profile_path = File.join(profiles_dir, "rusticgram_dist.mobileprovision")
    
    File.open(profile_path, "wb") do |f|
      f.write(Base64.decode64(profile_base64))
    end

    #
    # 2) Decode & import distribution certificate
    #
    cert_base64   = ENV["IOS_DIST_CERT"]
    cert_password = ENV["IOS_DIST_CERT_PASSWORD"]
    UI.user_error!("IOS_DIST_CERT is missing") if cert_base64.to_s.empty?
    UI.user_error!("IOS_DIST_CERT_PASSWORD is missing") if cert_password.to_s.empty?
    
    cert_path = File.expand_path("dist_cert.p12")
    File.open(cert_path, "wb") do |f|
      f.write(Base64.decode64(cert_base64))
    end

    keychain_name = "app-signing"
    keychain_password = "temp_keychain_password"
    
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false,
      add_to_search_list: true
    )

    import_certificate(
      certificate_path: cert_path,
      certificate_password: cert_password,
      keychain_name: keychain_name,
      keychain_password: keychain_password
    )

    #
    # 3) Authenticate using App Store Connect API key
    #
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )
  end

  desc "Upload only - archives and uploads to TestFlight"
  lane :beta_upload_only do
    # Setup signing first
    setup_signing
    
    # Archive and export
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Runner.ipa",
      archive_path: "./build/Runner.xcarchive",
      skip_build_archive: false,
      export_options: {
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "manual",
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => "rusticgram_dist"
        }
      },
      xcargs: "-allowProvisioningUpdates"
    )

    # Upload to TestFlight
    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      ipa: "./build/Runner.ipa"
    )
  end

  desc "Full beta lane - build and upload"
  lane :beta do
    setup_signing
    
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      export_options: {
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "manual",
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => "rusticgram_dist"
        }
      },
      xcargs: "-allowProvisioningUpdates COMPILER_INDEX_STORE_ENABLE=NO"
    )

    upload_to_testflight(
      app_identifier: ENV["APP_IDENTIFIER"],
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end
end